<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-08-26 Mon 15:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org009852e">1. Why Learn Docker?</a>
<ul>
<li><a href="#orgd11ceca">1.1. The Big Idea</a></li>
<li><a href="#org32c56d3">1.2. Using Docker</a></li>
<li><a href="#orgc429da3">1.3. Ports, Arguments, etc</a></li>
<li><a href="#org70b1103">1.4. Adding the Local Filesystem</a></li>
</ul>
</li>
<li><a href="#org97877b4">2. Taking R for a Spin</a></li>
<li><a href="#orgc84f302">3. Further Extending our Dockerfile</a></li>
<li><a href="#org0b2f675">4. Concluding Remarks</a></li>
<li><a href="#org44e9cdf">5. What Next?</a></li>
</ul>
</div>
</div>
<div id="outline-container-org009852e" class="outline-2">
<h2 id="org009852e"><span class="section-number-2">1</span> Why Learn Docker?</h2>
<div class="outline-text-2" id="text-1">
<p>
Docker is a "containerization engine." The idea here is to allow the
user to specify, in a simple text format, what a computer needs to do
a certain job. Docker then reads that specification, builds the
computer, and allows you, the user, to run it.
</p>

<p>
This was originally designed for use cases in Software Engineering. In
particular, Docker let's you create "reproducible deployments." It
used to be the case that software projects and the machines on which
they run were configured and maintained seperately. But since how
software runs often depends (in tricky ways) on the machine which runs
them, such two pronged maintenance was often complicated.
</p>

<p>
Docker allows engineers to develop software <span class="underline">and</span> a specification for
the machine on which that software should run. Docker provides a huge
suite of related capabilities for this use case.
</p>

<p>
So why should a datascientist care about Docker? Because data science
pipelines and programs also run in a context and you want that context
to be as reproducible as any other part of your work.
</p>
</div>

<div id="outline-container-orgd11ceca" class="outline-3">
<h3 id="orgd11ceca"><span class="section-number-3">1.1</span> The Big Idea</h3>
<div class="outline-text-3" id="text-1-1">
<p>
A good data science project should come with its own Docker file with
instructions for running the code in the specified container. That
way, anyone who gets their hands on your code and who also can run
Docker will be almost guaranteed to be able to run it.
</p>

<p>
Even if a user doesn't have access to a machine where they can build
and run Docker containers, the Dockerfile (as we shall see) is a
compact description of most of what they will need to run the code.
</p>
</div>
</div>

<div id="outline-container-org32c56d3" class="outline-3">
<h3 id="org32c56d3"><span class="section-number-3">1.2</span> Using Docker</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Once you have installed Docker according to the provided instructions
for your operating system, the first thing to do is test that it is
working.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Testing docker.</label><pre class="src src-bash" id="orgaecc5fc">docker run hello-world
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/

</pre>
</div>

<p>
This will "pull" a specified Docker image and run its default command,
which just prints out a message.
</p>

<p>
Almost all the Docker containers used in this book will be based on
<code>rocker/verse</code>. We can test that we have access to this image like so:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Invoking bash on the rocker/verse image.</label><pre class="src src-bash" id="org54c6003">docker run -it rocker/verse /bin/bash
</pre>
</div>

<p>
We should then expect to see a prompt like this one:
</p>

<div class="org-src-container">
<pre class="src src-org">root@dff56ba76b90: 

</pre>
</div>

<p>
What we are seeing here is a shell running inside of a sort of virtual
computer. How this machine is set up depends entirely on a
specification provided by the Docker container repository for
rocker/verse. 
</p>
</div>
</div>

<div id="outline-container-orgc429da3" class="outline-3">
<h3 id="orgc429da3"><span class="section-number-3">1.3</span> Ports, Arguments, etc</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The major benefit of the Rocker family of images is that they
contain an R Studio server instance pre-configured. This will allow
us to have a uniform development environment anywhere we (or anyone
else) can set up a Docker container.
</p>

<p>
The instructions associated with Rocker tell us to start our Docker
container like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">docker run -v $(pwd):/home/rstudio/work -e PASSWORD=yourpassword --rm -p 8787:8787 rocker/verse
</pre>
</div>

<p>
Given what we learned in the unix and shell scripting chapter, we
should be able to at least read this command line.
</p>

<p>
At its most basic level we are invoking the command "docker" with 7
arguments:
</p>

<div class="org-src-container">
<pre class="src src-bash">run\
-e\
PASSWORD=yourpassword\
--rm\
-p\
8787:8787\
rocker/verse
</pre>
</div>

<p>
It is up to the docker command to interpret these command line
arguments. Let's group them up by the conventions we learned in
Chapter 2.
</p>

<div class="org-src-container">
<pre class="src src-bash">run # this is the sub-command
-e PASSWORD=yourpassword ## -e lets us set an environment variable
			 ## in the container
--rm # delete the container when we are done
-p 8787:8787 ## expose port 8787 in the container
	     ## as port 8787 on localhost
rocker/verse ## the name of the docker image to run
</pre>
</div>

<p>
Networking is definitely outside of the scope of this course but we
do need to know a few things about it. Rstudio is a server - it
waits around for HTTP requests made by a web browser. Servers
listen on a "port" which we can use on a single computer to
distinguish many web servers.
</p>

<p>
The access a port on your local machine you type "localhost" into
your address bar and then <code>:port-number</code>. So if we start rocker as
above and visit <code>localhost:8787</code> we should see our rocker instance
running.
</p>

<p>
All that remains is to log in with "rstudio" and the password we
provided.
</p>
</div>
</div>

<div id="outline-container-org70b1103" class="outline-3">
<h3 id="org70b1103"><span class="section-number-3">1.4</span> Adding the Local Filesystem</h3>
<div class="outline-text-3" id="text-1-4">
<p>
In production scenarios Docker containers typically are
self-contained &#x2013; in our case that means that the code they are
meant to run will be built into the image and executed by the
Docker container's default command.
</p>

<p>
But most of what we will do here is <i>development</i> work, and for
that we want our container to be able to access our actual
filesystem, where we will be creating and editing files and
figures. To accomplish this, let's modify our command line for
launching the container like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">docker 
run # this is the sub-command
-e PASSWORD=yourpassword ## -e lets us set an environment variable
## in the container
--rm # delete the container when we are done
-p 8787:8787 ## expose port 8787 in the container
## as port 8787 on localhost
-v $(pwd):/home/rstudio/project ## place the current working directory
## at /home/rstudio/project inside the container     
rocker/verse ## the name of the docker image to run
</pre>
</div>

<p>
Now we just need to restart the Docker container. How do we do
that?
</p>

<p>
One possibility is pressing <code>CTRL-C</code> at the terminal where we
started the container. This sends the "kill" signal to the
container. But you may also want or need to kill a specific
container that is running. In fact, it is possible to launch a
container in the background. Docker provides its own process
management system:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>docker ps</label><pre class="src src-bash" id="org4a94671">docker ps
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">CONTAINER ID   IMAGE            COMMAND   CREATED        STATUS        PORTS                                       NAMES
b7ecf42bf2e0   rocker/verse   "/init"   19 hours ago   Up 19 hours   0.0.0.0:8787-&gt;8787/tcp, :::8787-&gt;8787/tcp   nostalgic_mirzakhani
</pre>
</div>

<p>
In the above example we see a single container running. We can kill it
by saying
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>killing a process</label><pre class="src src-bash" id="org10164fb">docker kill b7ec
</pre>
</div>

<p>
Note that we only need to include enough of the container ID to identify
it uniquely.
</p>

<p>
Now we can launch our machine:
</p>

<div class="org-src-container">
<pre class="src src-bash">docker run -e PASSWORD=yourpassword --rm -p 8787:8787 -v $(pwd):/home/rstudio/work rocker/verse
</pre>
</div>


<div class="figure">
<p><img src="./logged-in.png" alt="logged-in.png" />
</p>
<p><span class="figure-number">Figure 1: </span>R studio, without the mess.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org97877b4" class="outline-2">
<h2 id="org97877b4"><span class="section-number-2">2</span> Taking R for a Spin</h2>
<div class="outline-text-2" id="text-2">
<p>
We still need to learn to modify our Docker container but rather than
let our brains leak out of ears from boredome, let's do a little fake
data science.
</p>

<p>
(Note, for the examples in this book, I'm mounting the entire BIOS 611
repository under project.)
</p>

<p>
Our data set is scraped (see the scraping appendix) from the DC Fandom
Wiki and contains (among other things) meta-data about DC Comics
Characters as well as what Superhuman powers they may have.
</p>

<p>
Let's make a figure that compares power distribution against
"alignment."
</p>

<div class="org-src-container">
<pre class="src src-R">library(tidyverse)

d &lt;- read_csv("./data/powers.csv") %&gt;% 
  filter(universe=="New Earth") %&gt;% select(-universe, -url); 
alignment &lt;- read_csv("./data/character-data.csv") %&gt;%
  filter(universe=="New Earth" &amp; property_name == "Alignment") %&gt;%
  select(-universe, -property_name) %&gt;%
  rename(alignment=value);

alignment &lt;- rbind(alignment %&gt;% filter(alignment=="Good") %&gt;% sample_n(1000),
		   alignment %&gt;% filter(alignment=="Bad") %&gt;% sample_n(1000),
		   alignment %&gt;% filter(alignment=="Neutral") %&gt;% sample_n(1000));

power_tally &lt;- d %&gt;% group_by(power) %&gt;% tally() %&gt;% arrange(desc(n));


common_powers &lt;- d %&gt;% filter(power %in% head(power_tally,10)[["power"]]) %&gt;%
  left_join(alignment, by="character") %&gt;%
  mutate(power=factor(power, power_tally[["power"]])) %&gt;% 
  filter(alignment %in% c("Good","Bad","Neutral"));

p &lt;- ggplot(common_powers, aes(power)) + 
  geom_histogram(stat="count",position="dodge2",aes(fill=alignment)) + 
  theme(axis.text.x = element_text(angle = 90))
print(p)
</pre>
</div>


<div class="figure">
<p><img src="./power-histogram.png" alt="power-histogram.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Are powers distributed differently to evil characters?</p>
</div>

<p>
One way to answer this question is to create a boolean vector of
powers for each character and try to use that input as a model that
classifies a character as "good" or "evil". If we use a powerful
enough model, its failure can be taken as indicating that there isn't
so easy to assign an alignment based on a power distribution.
</p>

<p>
A good candidate is <a href="https://en.wikipedia.org/wiki/AdaBoost">AdaBoost</a>, which Wikipedia calls the "best out of
the box classifier." But before we get there we have to convert our
character data, which is a table like this:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> a subset of our power data.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">power</th>
<th scope="col" class="org-left">character</th>
<th scope="col" class="org-left">universe</th>
<th scope="col" class="org-left">url</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Abraham Dusk</td>
<td class="org-left">Wildstorm Universe</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Abraham_Dusk_(Wildstorm_Universe)">https://dc.fandom.com/wiki/Abraham_Dusk_(Wildstorm_Universe)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Accelerated Man</td>
<td class="org-left">Earth 19</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Accelerated_Man_(Earth_19)">https://dc.fandom.com/wiki/Accelerated_Man_(Earth_19)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Ahn Kwang-Jo</td>
<td class="org-left">Prime Earth</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Ahn_Kwang-Jo_(Prime_Earth)">https://dc.fandom.com/wiki/Ahn_Kwang-Jo_(Prime_Earth)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alec Holland</td>
<td class="org-left">Lego Batman</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alec_Holland_(Lego_Batman)">https://dc.fandom.com/wiki/Alec_Holland_(Lego_Batman)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alec Holland</td>
<td class="org-left">Prime Earth</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alec_Holland_(Prime_Earth)">https://dc.fandom.com/wiki/Alec_Holland_(Prime_Earth)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alexander Fairchild</td>
<td class="org-left">Wildstorm Universe</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alexander_Fairchild_(Wildstorm_Universe)">https://dc.fandom.com/wiki/Alexander_Fairchild_(Wildstorm_Universe)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alexander Luthor</td>
<td class="org-left">Smallville</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alexander_Luthor_(Smallville)">https://dc.fandom.com/wiki/Alexander_Luthor_(Smallville)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alexander Staunton</td>
<td class="org-left">Prime Earth</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alexander_Staunton_(Prime_Earth)">https://dc.fandom.com/wiki/Alexander_Staunton_(Prime_Earth)</a></td>
</tr>

<tr>
<td class="org-left">Accelerated Healing</td>
<td class="org-left">Alexander Trent</td>
<td class="org-left">New Earth</td>
<td class="org-left"><a href="https://dc.fandom.com/wiki/Alexander_Trent_(New_Earth)">https://dc.fandom.com/wiki/Alexander_Trent_(New_Earth)</a></td>
</tr>
</tbody>
</table>

<p>
(one row per character power combination) into a set of vectors (one
vector per character, as many dimensions as there are unique powers).
</p>

<p>
This is accomplished easily enough with what we have in our container:
</p>

<div class="org-src-container">
<pre class="src src-R">pivot_wider(d %&gt;% mutate(dummy=T),
	    character,names_from = power, values_from = dummy, values_fill = F);
</pre>
</div>

<p>
(don't worry if this is obscure - we will devote entire chapters to
this kind of manipulation) but if we want to plot these vectors in a
meaningful way, we need the "matlab" library, which provides an
implementation of "imagesc". We could just install a library as
we would ordinarily do in R:
</p>

<div class="org-src-container">
<pre class="src src-R">install.packages("matlab");
</pre>
</div>

<p>
But instead lets <i>add the library to our Docker container</i>. That way
anyone who gets our project will automatically have the library
installed.
</p>

<p>
We create a file called: "Dockerfile" and put this inside.
</p>

<div class="org-src-container">
<pre class="src src-Dockerfile">FROM rocker/verse 
RUN R -e "install.packages(\"matlab\")"
</pre>
</div>

<p>
A Dockerfile is a description of a container which we then ask Docker
to build. The first line above tells Docker that we want to base our
container on the pre-constructed container "rocker/verse". The "RUN"
line says that we want to execute a bit of code during the build
process. In this case, we are invoking R (as if we were on a Unix
terminal) and telling it (via its <code>-e</code> command line switch) to execute
a fragment of code. The way <code>rocker/verse</code> is set up R will
automatically select a mirror for this step.
</p>

<p>
Once we've saved our Dockerfile we can <i>build</i> our own Docker
container like this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Building a docker container</label><pre class="src src-bash" id="org6cbcb43">docker build . -t 611-example
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Sending build context to Docker daemon  207.4kB
Step 1/2 : FROM rocker/verse
 ---&gt; 9914bb59e96a
Step 2/2 : RUN R -e "install.packages(\"matlab\")"
 ---&gt; Running in a355c45f0300

R version 4.0.4 (2021-02-15) -- "Lost Library Book"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

&gt; install.packages("matlab")
Installing package into ‘/usr/local/lib/R/site-library’
(as ‘lib’ is unspecified)
trying URL 'https://packagemanager.rstudio.com/all/__linux__/focal/latest/src/contrib/matlab_1.0.2.tar.gz'
Content type 'binary/octet-stream' length 171431 bytes (167 KB)
==================================================
downloaded 167 KB

 * installing *binary* package ‘matlab’ ...
 * DONE (matlab)

The downloaded source packages are in
	‘/tmp/RtmprAB7aJ/downloaded_packages’
&gt; 
&gt; 
Removing intermediate container a355c45f0300
 ---&gt; ad2915350df6
Successfully built ad2915350df6
Successfully tagged 611-example:latest
</pre>
</div>

<p>
The <code>-t</code> argument tells docker we want to "tag" or "name" this
container "611-example." We'll use that name later to launch this new
container.
</p>

<p>
Now that our container is built let's kill our own container (save
your work first) and re-launch our new container.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Finding and killing our last container.</label><pre class="src src-bash" id="org0d50483">docker ps
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">CONTAINER ID   IMAGE          COMMAND   CREATED        STATUS        PORTS                                       NAMES
b18239add6ae   rocker/verse   "/init"   19 hours ago   Up 19 hours   0.0.0.0:8787-&gt;8787/tcp, :::8787-&gt;8787/tcp   youthful_stonebraker
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Starting our customized container.</label><pre class="src src-bash" id="orgf1a43ff">docker kill b18239add6ae
docker run -d -e PASSWORD=yourpassword --rm -p 8787:8787 -v $(pwd):/home/rstudio/project -t 611-example
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">1a5704a633073ea82fbdd4473e5634822fe7118de8a88df5b5f6a5c584cddc8b
</pre>
</div>

<p>
Note that we use <code>611-example</code> rather than <code>rocker/verse</code> as our
container name here. Docker gives us the id of our new container as
the output of the command.
</p>

<p>
Now we just re-connect to our container and we can add the following
to our toy script:
</p>

<div class="org-src-container">
<pre class="src src-R">library(matlab);
wider_data &lt;- pivot_wider(d %&gt;% mutate(dummy=T),
		       character,
		       names_from = power,
		       values_from = dummy,
		       values_fill = F);
vectors &lt;- wider_data %&gt;%
    select(-character) %&gt;%
    as.matrix() %&gt;%
    `*`(1.0);
imagesc(vectors);

write_csv(wider_data, "powers_wider.csv");

</pre>
</div>


<div class="figure">
<p><img src="./power-vectors.png" alt="power-vectors.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Character power vectors.</p>
</div>
</div>
</div>

<div id="outline-container-orgc84f302" class="outline-2">
<h2 id="orgc84f302"><span class="section-number-2">3</span> Further Extending our Dockerfile</h2>
<div class="outline-text-2" id="text-3">
<p>
We can do almost anything we'd like in a Dockerfile. It will
transpire in the course, for example, that we'd like to do some of
our analytic tasks in Python rather than in R. For example, the
easiest way to do basic neural network analysis, even if we want to
program in R, is to use <a href="https://keras.io/">Keras</a>. Whether we use Keras from R or
Python, we need to install the system. Let's extend our Dockerfile
to perform those actions.
</p>

<div class="org-src-container">
<pre class="src src-Dockerfile">FROM rocker/verse 
RUN R -e "install.packages(\"matlab\")"
RUN apt update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt install -y python3-pip
RUN pip3 install tensorflow
</pre>
</div>

<p>
We've added a few more <code>RUN</code> lines. These interact with the
operating system directly with the <code>apt</code> command. <code>apt</code> is the
package manager for the version of linux our container runs.
</p>

<p>
First we tell apt to update its list of software we can install and
then we tell it to install <code>python3-pip</code>. <code>pip</code> is <i>python</i>'s
package manager.
</p>

<p>
Our next <code>RUN</code> line uses <code>pip3</code> (the three indicates that <code>pip</code> is
for version 3 of python) to install keras.
</p>

<p>
Now we just rebuild our Docker image again.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Rebuilding again.</label><pre class="src src-bash" id="org511471d">docker build . -t 611-example  
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Sending build context to Docker daemon  262.1kB
Step 1/5 : FROM rocker/verse
 ---&gt; 9914bb59e96a
Step 2/5 : RUN R -e "install.packages(\"matlab\")"
 ---&gt; Using cache
 ---&gt; ad2915350df6
Step 3/5 : RUN apt update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt install -y python3-pip
 ---&gt; Using cache
 ---&gt; fcfa324e6a08
Step 4/5 : RUN pip3 install keras
 ---&gt; Using cache
 ---&gt; 59fc59691e20
Step 5/5 : RUN R -r "install.packages(\"keras\")"
 ---&gt; Running in 8b6d13c45197
WARNING: unknown option '-r'

ARGUMENT 'install.packages("keras")' __ignored__


R version 4.0.4 (2021-02-15) -- "Lost Library Book"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

&gt; 
Removing intermediate container 8b6d13c45197
 ---&gt; 99f7c9965d41
Successfully built 99f7c9965d41
Successfully tagged 611-example:latest
</pre>
</div>

<p>
Now we can restart our Docker container and visit our terminal in
RStudio and see if we have keras.
</p>

<p>
Once that is done we can write a simple script to do a basic
auto-encoder on our vector data.
</p>

<div class="org-src-container">
<pre class="src src-python">from tensorflow import keras
from tensorflow.keras import layers

import pandas as pd
import numpy as np

from math import floor, ceil

data = pd.read_csv("wider_data.csv");
numerical_data = data[data.columns[2:]].values*1.0;
numerical_data = numerical_data.astype('float32');

n_col = numerical_data.shape[1];

n_rep = 2;


input = keras.Input(shape=(n_col,))

encoder = layers.Dropout(0.3)(input);
encoder = layers.Dense(64, activation='relu')(encoder);
encoder = layers.Dense(32, activation='relu')(encoder);
encoder = layers.Dense(16, activation='relu')(encoder);
encoder = layers.Dense(8, activation='relu')(encoder);

representer = layers.Dense(n_rep, activation='relu')(encoder);

decoder = layers.Dense(8, activation='relu')(representer);
decoder = layers.Dense(16, activation='relu')(decoder);
decoder = layers.Dense(32, activation='relu')(decoder);
decoder = layers.Dense(64, activation='relu')(decoder);
decoder = layers.Dense(n_col, activation='linear')(decoder);

auto_encoder = keras.Model(input, decoder);
auto_encoder.compile(optimizer='adam', loss='binary_crossentropy');

encoder=keras.Model(input, representer);

metrics = auto_encoder.fit(numerical_data, numerical_data,
		 epochs=2000,
		 batch_size=50,
		 shuffle=True);

keras.models.save_model(auto_encoder, "model_auto_encoder");
keras.models.save_model(encoder, "model_encoder");

encoded = encoder.predict(numerical_data);
encoded = pd.DataFrame(encoded, columns=['D1','D2']);

def encompos_percentage(d,percentage):
    d = sorted(d);
    n = round(len(d)*percentage);
    n_drop = len(d)-n;
    n_drop_low = floor(n_drop/2);
    n_drop_high = ceil(n_drop/2);
    chopped = d[n_drop_low:-n_drop_high];
    return [chopped[0], chopped[-1]];

def get_limits(df,p):
    return {"xl":encompos_percentage(df['D1'],p),
	    "yl":encompos_percentage(df['D2'],p)};


limits = get_limits(encoded, 0.9);

from plotnine import *

the_plot = (ggplot(encoded,aes('D1','D2')) + geom_point() + xlim(limits["xl"][0],limits["xl"][1]) +
 ylim(limits["yl"][0],limits["yl"][1]));

ggplot.save(the_plot,filename="encoded_rep.png");
</pre>
</div>

<p>
Which results in something like this:
</p>


<div id="orgd846e7d" class="figure">
<p><img src="./encoded_rep.png" alt="encoded_rep.png" />
</p>
<p><span class="figure-number">Figure 4: </span>The autoencoder representation of the powers data.</p>
</div>
</div>
</div>

<div id="outline-container-org0b2f675" class="outline-2">
<h2 id="org0b2f675"><span class="section-number-2">4</span> Concluding Remarks</h2>
<div class="outline-text-2" id="text-4">
<p>
What have we earned by learning to use Docker like this? Well,
imagine we distribute our project with a README like this:
</p>


<div class="org-src-container">
<pre class="src src-markdown">Super Hero Power Analysis
=========================

Hi, Welcome to my small project to analyze super hero powers.

To run this code, just build the docker container like this:

```
docker build . -t hero
```

And then start an RStudio server like this:

```
docker run -e PASSWORD=dolly_parton \
  -v $(pwd):/home/rstudio/work\
  -p 8787:8787 --rm\
  hero
```

And visit http://localhost:8787 in your browser. Log in with user
`rstudio` and password `dolly_parton`.

</pre>
</div>

<p>
Once inside this docker container, the user can focus on your
analysis, not on installing libraries.
</p>

<p>
Furthermore, the Dockerfile serves as the authoritative
representation of what you need to run the project.
</p>
</div>
</div>

<div id="outline-container-org44e9cdf" class="outline-2">
<h2 id="org44e9cdf"><span class="section-number-2">5</span> What Next?</h2>
<div class="outline-text-2" id="text-5">
<p>
You may have noticed that our project is starting to get a little
complicated, even if we have solved the problem with distributing
libraries along with our data analysis. Less obviously, I've gone
through several versions of this lecture and associated material
while preparing these notes. What if someone is interested in a
previous version of this lecture?
</p>

<p>
Over the next few topics we will begin to tame these beasts.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2024-08-26 Mon 15:44</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
